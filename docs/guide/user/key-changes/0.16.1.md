# 0.16.1

## 変更点

ここでは主要な変更を紹介します。全ての変更点については[CHANGELOG.md]をご覧ください。

### \[Java\] \[Windows,macOS,Linux\] GitHub ReleaseにPC用のパッケージを追加

java\_package.zipの中に`jp.hiroshiba.voicevoxcore » voicevoxcore`が追加されました。Windows、macOS、Linuxに対応しています。

```diff
 java_packages.zip
 └── jp
     └── hiroshiba
         └── voicevoxcore
+            ├── voicevoxcore/
             └── voicevoxcore-android/
```

### \[C\] `…_free`系と`…_delete`系の関数がヌルポインタを許容

`free(3)`や[`HeapFree`]のようにヌルポインタを許容するようになりました。例えば純粋なC言語において、"goto cleanup"パターンが書きやすくなります。

```diff
 cleanup:
-  if (openjtalk)   voicevox_open_jtalk_rc_delete(openjtalk);
-  if (synthesizer) voicevox_synthesizer_delete(synthesizer);
-  if (vvm)         voicevox_voice_model_file_delete(vvm);
-  if (wav)         voicevox_wav_free(wav);
+                   voicevox_open_jtalk_rc_delete(openjtalk);
+                   voicevox_synthesizer_delete(synthesizer);
+                   voicevox_voice_model_file_delete(vvm);
+                   voicevox_wav_free(wav);
```

### \[Rust,Python,Java\] 基本的なインターフェイスや特殊メソッドを実装

以下のものが実装されました。

<details><summary>Rust API</summary>

- `Debug` for
    - `AudioQuery`
    - `UserDictWordBuilder`
    - `{blocking,nonblocking}.onnxruntime.LoadOnce`
    - `{blocking,nonblocking}.VoiceModelFile`
    - `{blocking,nonblocking}.OpenJtalk`
    - `{blocking,nonblocking}.Synthesizer`
    - `{blocking,nonblocking}.synthesizer.*`
- `PartialEq` for
    - `StyleMeta`
    - `AudioQuery`
    - `UserDictWord`
- `{PartialOrd,Ord}` for
    - `AccelerationMode`
    - `UserDictWordType`
- `Hash` for
    - `CharacterVersion`
    - `AccelerationMode`
- `{AsRef,AsMut}` for `CharacterVersion`
- `{UpperHex,LowerHex,Octal,Binary}` for `StyleId`
- `Into<u32>` for `StyleId` (via `From`)
</details>
<details><summary>Python API</summary>

- `__repr__` for
    - `{blocking,asyncio}.VoiceModelFile`
    - `{blocking,asyncio}.Onnxruntime`
    - `{blocking,asyncio}.VoiceModelFile`
    - `{blocking,asyncio}.OpenJtalk`
    - `{blocking,asyncio}.UserDict`
</details>
<details><summary>Java API</summary>

- `Object.equals` for
    - `SupportedDevices`
    - `StyleMeta`
    - `CharacterMeta`
    - `Mora`
    - `AccentPhrase`
    - `AudioQuery`
- `Cloneable` for
    - `SupportedDevices`
    - `StyleMeta`
    - `CharacterMeta`
    - `Mora`
</details>

### \[ダウンローダー\] voicevox\_vvmのバージョン0.16に対応

`models`のダウンロード元が[VOICEVOX/voicevox\_vvm]の`>=0.16,<0.17`になります。

[voicevox\_vvmのバージョン0.16.0]には以下の変更が含まれます。今後`>=0.16.1,<0.17`のvoicevox\_vvmをリリースする際は、voicevox\_coreリポジトリでは案内をしません。

- [10期生]および同時期に作られていた追加スタイルに対応するVVM(19.vvm、20.vvm、21.vvm)を追加
- ソング用VVM(s0.vvm)を追加
- [`Character::version`を`0.1.0`から`0.16.0`に変更]

またvoicevox\_vvm 0.16の対応に伴い、`VoiceModelId`が指すIDが何に対して固有なのかが暫定的に定められました。詳細は各言語のドキュメンテーションコメントをご覧ください。

### \[ダウンローダー\] リトライ機構

デフォルトで4回のリトライを行うようになりました。この回数は`-t, --tries <NUMBER>`で変更可能です。

```console
  -t, --tries <NUMBER>
          ダウンロードにおける試行回数。'0'か'inf'で無限にリトライ [default: 5]
```

現段階では以下に示す挙動をします。

- 各試行は`<TARGET>`単位で行われる。ダウンロードしたzipやtgzの解凍に失敗してもリトライが行われる。また`models`の場合、どれか一つのVVMのダウンロードに失敗すると、他のVVMも全部まとめてリトライが行われる。
- プログレスバーを出す前の段階でエラーが発生した場合、リトライは行われない。

これらの挙動は将来的に変更される予定であり、議論は[#1127]で行われています。

### \[ダウンローダー\] `--models-version <SEMVER>`オプションを追加

`--c-api-version`や`--onnxruntime-version`のように、VOICEVOX/voicevox\_vvmのバージョンを指定できるオプションが追加されました。

```console
      --models-version <SEMVER>
          VOICEVOX音声モデル (`models`)のバージョン。省略時は`>=0.16, <0.17`のうちpre-releaseではない最新
```

他のバージョン指定オプションとは異なり、省略時には`latest`ではなく一定範囲の非pre-releaseのリリースから最新のものが選択されるようになっています。

ダウンローダーから見て未来のバージョンを使うことも可能になります。ただしその場合は警告が出ます。

### \[ダウンローダー\] `--models-pattern <GLOB>`オプションを追加

特定の名前のVVMだけをダウンロードするようにできるオプションが追加されました。

```console
      --models-pattern <GLOB>
          ダウンロードするVVMファイルのファイル名パターン [default: *]
```

例えばダウンロード対象を特定のVVMのみにしたり、トーク用、あるいは先述したソング用VVMに限定することができるようになります。

```console
❯ download --models-pattern 0.vvm # 0.vvmのみダウンロード
```

```console
❯ download --models-pattern '[0-9]*.vvm' # トーク用VVMに絞り、ソング用VVMをダウンロードしないように
```

### \[ダウンローダー\] `-V, --version`オプションを追加

ダウンローダーは正式にVOICEVOX COREの一部と定められ、バージョンを共にするようになりました。それに伴って`-V, --version`でVOICEVOX CORE兼ダウンローダーのバージョンを見ることができるようになりました。

```console
  -V, --version
          Print version
```

```console
❯ download -V
VOICEVOX CORE 0.16.1 downloader
```

### \[ダウンローダー\] GitHubの認証トークンを設定できる機能を正式なものとし、ドキュメント化

Rust版ダウンローダー実装当初から存在した機能ですが、このたび正式に使い方が説明されます。GitHubはトークン無しのアクセスに低いレートリミットを課しているため、設定することをおすすめします。

設定方法は環境変数`GITHUB_TOKEN`にセットするというものです。また、本バージョンでは`GH_TOKEN`からでも設定できるようになりました。両方の環境変数が存在する場合は`GH_TOKEN`が優先されます。

```console
GH_TOKEN=$(gh auth token) download …
```

上記の内容は`--help`および[downloader.md]から見ることができます。

### \[ダウンローダー\] `--help`の充実

今回から`-h`で出るヘルプと`--help`で出るヘルプは別のものになります。簡潔な説明は`-h`で、詳細な説明は`--help`で行われます。`--help`の方のヘルプでは、[downloader.md]に書かれているような内容も盛り込まれています。

### バグ修正

詳細は[CHANGELOG.md]をご覧ください。

- \[Python\] リポジトリにあるMarkdownドキュメントの誤記の修正
- \[Java\] \[Android\] GHAのUbuntuイメージ備え付けの`$ANDROID_NDK` (現時点ではバージョン27)を使ってリリースすることにより、AndroidビルドにおけるC++シンボルの問題を解決
- \[Java\] Javaのファイナライザから中身のRustオブジェクトのデストラクトがされない問題を解決
- \[ダウンローダー\] いくつかのエラーの出かたを改善
- \[ダウンローダー\] ヘルプにおいて誤っていた記述を修正
- \[ダウンローダー\] \[Windows\] GitHub Releasesにおいて、再び署名がされるように

## 謝辞

以下の方々から貢献をいただきました。この場を借りてお礼申し上げます。

- [@shuntia]さん \([#1098]\)
- [@walker27460]さん \([#1103]\)

[CHANGELOG.md]: https://github.com/VOICEVOX/voicevox_core/blob/main/CHANGELOG.md#0161---2025-08-14-0900
[`HeapFree`]: https://learn.microsoft.com/en-us/windows/win32/api/heapapi/nf-heapapi-heapfree
[VOICEVOX/voicevox\_vvm]: https://github.com/VOICEVOX/voicevox_vvm
[voicevox\_vvmのバージョン0.16.0]: https://github.com/VOICEVOX/voicevox_vvm/releases/tag/0.16.0
[10期生]: https://voicevox.hiroshiba.jp/dormitory/#10th
[`Character::version`を`0.1.0`から`0.16.0`に変更]: https://github.com/VOICEVOX/voicevox_vvm/pull/34
[#1127]: https://github.com/VOICEVOX/voicevox_core/issues/1127
[downloader.md]: https://github.com/VOICEVOX/voicevox_core/blob/0.16.1/docs/guide/user/downloader.md
[@shuntia]: https://github.com/shuntia
[#1098]: https://github.com/VOICEVOX/voicevox_core/pull/1098
[@walker27460]: https://github.com/walker27460
[#1103]: https://github.com/VOICEVOX/voicevox_core/issues/1103
