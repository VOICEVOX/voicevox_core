name: Build C++ Shared Library

on:
  push:
    branches:
      # - main
  release:
    types:
      - published
  workflow_dispatch:

env:
  # Raw character weights are not public.
  # Skip uploading to GitHub Release on public repo.
  SKIP_UPLOADING_RELEASE_ASSET: ${{ secrets.SKIP_UPLOADING_RELEASE_ASSET || '1' }}

jobs:
  build-onnxruntime:
    strategy:
      fail-fast: false
      matrix:
        include:
          - artifact_name: onnxruntime-linux-armhf-cpu
            context_dir: .github/build/onnxruntime-armhf
            onnxruntime_version: v1.8.2
            os: ubuntu-18.04
            image_tag: voicevox_core:onnxruntime-armhf
            base_image: ubuntu:bionic
            cc_version: '8'
            cxx_version: '8'
            arch: arm-linux-gnueabihf
            cmake_system_processor: armv7l
            ld_symlink_name: ld-linux-armhf.so.3
            atomic: '1'
            build_opts: --arm --config Release --parallel --update --build --build_shared_lib
            result_dir: build/Linux/Release

    env:
      IMAGE_TAG: ${{ secrets.DOCKERHUB_USERNAME }}/${{ matrix.image_tag }}

    runs-on: ${{ matrix.os }}

    steps:
      - name: Checkout
        uses: actions/checkout@v2

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v1

      - name: Setup Docker Buildx
        id: buildx
        uses: docker/setup-buildx-action@v1

      - name: Available platforms
        run: echo ${{ steps.buildx.outputs.platforms }}

      - name: Login to DockerHub
        uses: docker/login-action@v1
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build Docker image
        id: build-docker-image
        uses: docker/build-push-action@v2
        with:
          context: .github/build/onnxruntime-armhf
          builder: ${{ steps.buildx.outputs.name }}
          # file: ./Dockerfile
          build-args: |
            BASE_IMAGE=${{ matrix.base_image }}
            CC_VERSION=${{ matrix.cc_version }}
            CXX_VERSION=${{ matrix.cxx_version }}
            ARCH=${{ matrix.arch }}
            CMAKE_SYSTEM_PROCESSOR=${{ matrix.cmake_system_processor }}
            LD_SYMLINK_NAME=${{ matrix.ld_symlink_name }}
            ONNXRUNTIME_VERSION=${{ matrix.onnxruntime_version }}
            ATOMIC=${{ matrix.atomic }}
          # target: ${{ matrix.target }}
          # platforms: ${{ matrix.platform }}
          load: true
          tags: ${{ env.IMAGE_TAG }}
          cache-from: type=registry,ref=${{ env.IMAGE_TAG }}-buildcache
          cache-to: type=registry,ref=${{ env.IMAGE_TAG }}-buildcache,mode=max

      - name: Dump matrix context
        env:
          MATRIX_CONTEXT: ${{ toJSON(matrix) }}
        run: echo "$MATRIX_CONTEXT" > matrix.json

      - name: Cache build result
        id: cache-build-result
        uses: actions/cache@v2
        env:
          DOCKERFILE_PATH: ${{ matrix.context_dir }}/Dockerfile
        with:
          path: build/
          key: onnxruntime-build-cache-v1-${{ matrix.onnxruntime_version }}-${{ steps.build-docker-image.outputs.digest }}-${{ hashFiles('matrix.json') }}

      - name: Build ONNX Runtime
        if: steps.cache-build-result.outputs.cache-hit != 'true'
        run: |
          docker run --rm \
            -v "${PWD}/build:/onnxruntime/build" \
            ${{ env.IMAGE_TAG }} bash ./build.sh ${{ matrix.build_opts }}

      - name: Organize artifact
        run: |
          mkdir artifact

          # copy build artifact
          mkdir artifact/lib
          NAME=$(basename ${{ matrix.result_dir }}/libonnxruntime.so.*)
          cp "${{ matrix.result_dir }}/${NAME}" artifact/lib/
          ln -s ${NAME} artifact/lib/libonnxruntime.so

          # create a container to copy files from microsoft/onnxruntime repository
          CONTAINER_ID=$(docker run -d ${{ env.IMAGE_TAG }})

          # copy header files
          mkdir ./artifact/include
          readarray -t HEADERS <<EOF
          onnxruntime/core/session/onnxruntime_c_api.h
          onnxruntime/core/session/onnxruntime_cxx_api.h
          onnxruntime/core/session/onnxruntime_cxx_inline.h
          onnxruntime/core/providers/cpu/cpu_provider_factory.h
          onnxruntime/core/session/onnxruntime_session_options_config_keys.h
          onnxruntime/core/session/onnxruntime_run_options_config_keys.h
          onnxruntime/core/framework/provider_options.h
          EOF

          for path in "${HEADERS[@]}"; do
            docker cp "$CONTAINER_ID:/onnxruntime/include/${path}" ./artifact/include/
          done

          # copy docs & metadata
          docker cp $CONTAINER_ID:/onnxruntime/VERSION_NUMBER ./artifact/
          docker cp $CONTAINER_ID:/onnxruntime/LICENSE ./artifact/
          docker cp $CONTAINER_ID:/onnxruntime/ThirdPartyNotices.txt ./artifact/
          docker cp $CONTAINER_ID:/onnxruntime/docs/Privacy.md ./artifact/
          docker cp $CONTAINER_ID:/onnxruntime/README.md ./artifact/
          docker rm -f $CONTAINER_ID

          echo "$GITHUB_SHA" >> ./artifact/GIT_COMMIT_ID

      - name: Upload artifact
        uses: actions/upload-artifact@v2
        with:
          name: ${{ matrix.artifact_name }}
          path: artifact/*
          retention-days: 7


  build-cpp-shared:
    needs:
      - build-onnxruntime

    strategy:
      fail-fast: false
      matrix:
        include:
          - os: windows-2019
            device: gpu
            onnxruntime_url: https://github.com/microsoft/onnxruntime/releases/download/v1.9.0/onnxruntime-win-x64-gpu-1.9.0.zip
            cmake_additional_options: -DENABLE_CUDA=ON
            artifact_name: windows-x64-gpu

          - os: windows-2019
            device: cpu-x64
            onnxruntime_url: https://github.com/microsoft/onnxruntime/releases/download/v1.9.0/onnxruntime-win-x64-1.9.0.zip
            artifact_name: windows-x64-cpu

          - os: windows-2019
            device: cpu-x86
            onnxruntime_url: https://github.com/microsoft/onnxruntime/releases/download/v1.9.0/onnxruntime-win-x86-1.9.0.zip
            cmake_additional_options: -DCMAKE_GENERATOR_PLATFORM=Win32
            artifact_name: windows-x86-cpu

          - os: windows-2019
            device: cpu-arm64
            onnxruntime_url: https://github.com/microsoft/onnxruntime/releases/download/v1.9.0/onnxruntime-win-arm64-1.9.0.zip
            cmake_additional_options: -DCMAKE_GENERATOR_PLATFORM=arm64
            artifact_name: windows-arm64-cpu

          - os: windows-2019
            device: cpu-arm
            onnxruntime_url: https://github.com/microsoft/onnxruntime/releases/download/v1.9.0/onnxruntime-win-arm-1.9.0.zip
            cmake_additional_options: -DCMAKE_GENERATOR_PLATFORM=arm
            artifact_name: windows-arm-cpu

          - os: macos-10.15
            device: cpu-x64
            onnxruntime_url: https://github.com/microsoft/onnxruntime/releases/download/v1.9.0/onnxruntime-osx-x64-1.9.0.tgz
            artifact_name: osx-x64-cpu

          - os: ubuntu-18.04
            device: gpu
            onnxruntime_url: https://github.com/microsoft/onnxruntime/releases/download/v1.9.0/onnxruntime-linux-x64-gpu-1.9.0.tgz
            cmake_additional_options: -DENABLE_CUDA=ON
            artifact_name: linux-x64-gpu
            cc_version: '8'
            cxx_version: '8'

          - os: ubuntu-18.04
            device: cpu-x64
            onnxruntime_url: https://github.com/microsoft/onnxruntime/releases/download/v1.9.0/onnxruntime-linux-x64-1.9.0.tgz
            artifact_name: linux-x64-cpu
            cc_version: '8'
            cxx_version: '8'

          - os: ubuntu-18.04
            device: cpu-armhf
            onnxruntime_artifact_name: onnxruntime-linux-armhf-cpu
            artifact_name: linux-armhf-cpu
            cc_version: '8'
            cxx_version: '8'
            arch: arm-linux-gnueabihf

    runs-on: ${{ matrix.os }}

    steps:
      - uses: actions/checkout@v2

      - run: mkdir download

      # ONNX Runtime
      - name: Export ONNX Runtime url to calc hash
        if: matrix.onnxruntime_artifact_name == ''
        shell: bash
        run: echo "${{ matrix.onnxruntime_url }}" > download/onnxruntime_url.txt

      - name: Cache ONNX Runtime
        if: matrix.onnxruntime_artifact_name == ''
        uses: actions/cache@v2
        id: onnxruntime-cache
        with:
          key: ${{ matrix.os }}-${{ matrix.device }}-onnxruntime-cache-v1-${{ hashFiles('download/onnxruntime_url.txt') }}
          path: download/onnxruntime

      # download/onnxruntime/lib/onnxruntime.dll
      - name: Download ONNX Runtime (zip)
        if: matrix.onnxruntime_artifact_name == '' && steps.onnxruntime-cache.outputs.cache-hit != 'true' && endsWith(matrix.onnxruntime_url, '.zip')
        shell: bash
        run: |
          curl -L "${{ matrix.onnxruntime_url }}" > download/onnxruntime.zip
          mkdir -p download/onnxruntime

          # strip-components
          TEMPDIR=$(mktemp -d)
          unzip download/onnxruntime.zip -d "${TEMPDIR}"
          mv "${TEMPDIR}"/*/* download/onnxruntime/
          rm -rf "${TEMPDIR}"

          rm download/onnxruntime.zip

      # download/onnxruntime/lib/libonnxruntime.so
      # download/onnxruntime/lib/libonnxruntime.dylib
      - name: Download ONNX Runtime (tgz)
        if: matrix.onnxruntime_artifact_name == '' && steps.onnxruntime-cache.outputs.cache-hit != 'true' && endsWith(matrix.onnxruntime_url, '.tgz')
        shell: bash
        run: |
          curl -L "${{ matrix.onnxruntime_url }}" > download/onnxruntime.tgz
          mkdir -p download/onnxruntime
          tar xf download/onnxruntime.tgz -C download/onnxruntime --strip-components 1
          rm download/onnxruntime.tgz

      - name: Download ONNX Runtime (artifact)
        if: matrix.onnxruntime_artifact_name != ''
        uses: actions/download-artifact@v2
        with:
          name: ${{ matrix.onnxruntime_artifact_name }}
          path: download/onnxruntime/

      # Build
      - if: startsWith(matrix.os, 'windows')
        uses: ilammy/msvc-dev-cmd@v1

      - if: startsWith(matrix.os, 'mac')
        uses: jwlawson/actions-setup-cmake@v1.9

      # gcc 7 (ubuntu-18.04 default) does not have stdc++fs
      - name: Install build-essential
        if: startsWith(matrix.os, 'ubuntu')
        shell: bash
        env:
          ARCH: "-${{ (matrix.arch != '' && matrix.arch) || '' }}"
          ARCH_SUFFIX: ${{ (env.ARCH != '-' && env.ARCH) || '' }}
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            gcc-${{ matrix.cc_version }}${{ env.ARCH_SUFFIX }} \
            g++-${{ matrix.cxx_version }}${{ env.ARCH_SUFFIX }} \
            cmake

      - name: Configure (Windows, macOS)
        if: ${{ !startsWith(matrix.os, 'ubuntu') }} # '!' cannot be used as a first character in YAML
        shell: bash
        working-directory: onnx
        run: |
          cmake -DONNXRUNTIME_DIR=../download/onnxruntime ${{ matrix.cmake_additional_options }} .

      - name: Configure (Linux)
        if: startsWith(matrix.os, 'ubuntu')
        shell: bash
        working-directory: onnx
        env:
          ARCH: "${{ (matrix.arch != '' && matrix.arch) || '' }}-"
          ARCH_PREFIX: ${{ (env.ARCH != '-' && env.ARCH) || '' }}
          CC: ${{ env.ARCH_PREFIX }}gcc-${{ matrix.cc_version }}
          CXX: ${{ env.ARCH_PREFIX }}g++-${{ matrix.cxx_version }}
        run: |
          cmake -DONNXRUNTIME_DIR=../download/onnxruntime ${{ matrix.cmake_additional_options }} .

      - name: Build
        shell: bash
        working-directory: onnx
        run: |
          cmake --build . --config Release

          # copy lib to onnx/lib/* and set rpath (linux)
          cmake --install .

          # remove files with duplicate names to create a flat release archive
          cd lib

          if [ "${{ matrix.artifact_name }}" = "linux-armhf-cpu" ]; then
            mkdir "${{ matrix.artifact_name }}"
            mv libonnxruntime* "${{ matrix.artifact_name }}"/
          fi

          rm -f onnxruntime* libonnxruntime* core.h core.lib

      # Upload
      - name: Upload artifact
        uses: actions/upload-artifact@v2
        with:
          name: ${{ matrix.artifact_name }}-cpp-shared
          path: onnx/lib/*
          retention-days: 7

  # Create core.zip
  upload-to-release-cpp-shared:
    if: github.event.release.tag_name != ''
    needs: [build-cpp-shared]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2

      - name: Set BUILD_IDENTIFIER env var
        run: |
          echo "BUILD_IDENTIFIER=${GITHUB_REF##*/}" >> $GITHUB_ENV

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
              zip

      - name: Download and extract artifact
        uses: actions/download-artifact@v2
        with:
          path: artifacts/

      - name: Rearchive artifacts
        run: |
          mkdir release

          readarray -t MAPPINGS <<EOF
          windows-x64-gpu   core.dll      core_gpu_x64_nvidia.dll
          windows-x64-cpu   core.dll      core_cpu_x64.dll
          windows-x86-cpu   core.dll      core_cpu_x86.dll
          windows-arm64-cpu core.dll      core_cpu_arm64.dll
          windows-arm-cpu   core.dll      core_cpu_arm.dll
          osx-x64-cpu       libcore.dylib libcore_cpu_x64.dylib
          linux-x64-gpu     libcore.so    libcore_gpu_x64_nvidia.so
          linux-x64-cpu     libcore.so    libcore_cpu_x64.so
          linux-armhf-cpu   libcore.so    libcore_cpu_armhf.so
          EOF

          for line in "${MAPPINGS[@]}"; do
            KND=$(echo $line | awk '$0=$1')
            SRC=$(echo $line | awk '$0=$2')
            DST=$(echo $line | awk '$0=$3')

            if [ "${SRC}" = "${DST}" ]; then
              echo "Skip renaming ${KND}/${SRC} => ${DST}"
              continue
            fi

            echo "Renaming ${KND}/${SRC} => ${DST}"
            mv "artifacts/${KND}-cpp-shared/${SRC}" "artifacts/${KND}-cpp-shared/${DST}"
          done

          mv artifacts/*/* release/

          cp core.h release/

          echo "${{ env.BUILD_IDENTIFIER }}" > release/VERSION

          cd release/
          zip -r ../core.zip *

      - name: Upload artifact
        uses: actions/upload-artifact@v2
        with:
          name: core
          path: release/*

      - name: Upload to Release
        if: env.SKIP_UPLOADING_RELEASE_ASSET == '0'
        uses: svenstaro/upload-release-action@v2
        with:
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          tag: ${{ github.ref }} # ==> github.event.release.tag_name
          file: core.zip
